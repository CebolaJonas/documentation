<!-- Get shortcode parameters -->
{{- $text := .Get "text" -}}
{{- $tooltip := .Get "tooltip" -}}
{{- $glossary := .Get "glossary" -}}

<!-- Initialize variables -->
{{- $displayText := $text -}}
{{- $tooltipContent := $tooltip -}}
{{- $fullDefinitionLink := "" -}}
{{- $glossaryMatch := false -}}

<!-- Handle glossary terms if provided -->
{{- if $glossary -}}
  {{- $glossaryTerm := replace $glossary " " "_" -}}
  {{- $headless := .Site.GetPage "/glossary/terms" -}}
  {{- with $headless.Resources.GetMatch (printf "%s.md" $glossaryTerm) -}}
    {{- $glossaryMatch = true -}}
    {{- $displayText = .Title -}}
    {{- if .Params.short_definition -}}
      {{- $tooltipContent = .Params.short_definition -}}
      {{- $fullDefinitionLink = printf "/glossary/#%s" ($glossary | urlize) -}}
    {{- else -}}
      {{- $content := .Content | plainify -}}
      {{- $tooltipContent = $content | replaceRE `\n\[\d+\]:\s+.*` "" | replaceRE `\[([^\]]+)\]\[\d+\]` "$1" | safeHTML -}}
    {{- end -}}
  {{- else -}}
    {{- $displayText = $glossary -}}
    {{- warnf "Glossary term '%s' not found" $glossary -}}
  {{- end -}}
{{- end -}}

<!-- Render tooltip -->
{{- if or $glossaryMatch (and $text $tooltip) -}}
<span class="tooltip-container"><button class="tooltip-trigger" aria-describedby="tooltip-{{ $displayText | anchorize }}">{{ $displayText }}</button><span id="tooltip-{{ $displayText | anchorize }}" class="tooltip-content" role="tooltip">{{ $tooltipContent | safeHTML }}{{- if $fullDefinitionLink -}}<a href="{{ $fullDefinitionLink }}" class="tooltip-full-link" aria-label="View full definition">Glossary</a>{{- end }}</span></span>
{{- else -}}
{{- $displayText -}}
{{- end -}}
